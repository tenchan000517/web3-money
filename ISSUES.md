# WEB3 MONEY - Code Review Issues

## 🚨 Critical Security Issues (優先度: 最高)

### 1. API認証の欠如
- **場所**: `/src/app/api/gas/route.ts`
- **問題**: APIエンドポイントに認証機能が実装されていない
- **リスク**: 誰でもすべてのAPIエンドポイントにアクセス可能
- **対策**: JWT認証またはセッションベース認証の実装が必要

### 2. CORS設定の脆弱性
- **場所**: `/src/app/api/gas/route.ts:11`
- **問題**: `Access-Control-Allow-Origin: '*'` ですべてのオリジンを許可
- **リスク**: クロスサイトリクエストフォージェリ（CSRF）攻撃の可能性
- **対策**: 特定のドメインのみ許可するよう修正

### 3. Google Apps Script URLのハードコーディング
- **場所**: `/src/app/api/gas/route.ts:3`
- **問題**: GAS URLが直接ソースコードに記載
- **リスク**: 内部インフラストラクチャの露出
- **対策**: 環境変数への移行

### 4. リファラーチェックの脆弱性
- **場所**: `/src/app/relay/page.tsx`
- **問題**: クライアントサイドでのリファラーチェックは簡単に回避可能
- **リスク**: アクセス制御の無効化
- **対策**: サーバーサイドでの検証実装

### 5. 入力検証の不足
- **場所**: `/gas-files/database.gs:159`
- **問題**: `isValidString`関数が長さのチェックのみでサニタイゼーションなし
- **リスク**: インジェクション攻撃の可能性
- **対策**: 適切な入力サニタイゼーションの実装

### 6. 欠落している関数
- **場所**: `/gas-files/auth.gs:19`
- **問題**: `isValidEmail`関数が未定義
- **リスク**: アプリケーションクラッシュ
- **対策**: メールバリデーション関数の実装

## 🔥 高優先度の問題

### フロントエンド

#### 1. 重複ファイルの存在
- `/src/lib/api copy.ts`
- `/src/app/api/gas/route copy.ts`
- `/src/app/api/gas/route copy 2.ts`
- `/src/app/main/page copy.tsx`
- `/src/app/relay/page copy.tsx`
- `/src/components/VotingCard copy.tsx`

**対策**: すべての重複ファイルを削除

#### 2. ハードコーディングされた開発フラグ
- **場所**: `/src/app/main/page.tsx:16`, `/src/app/relay/page.tsx:12`
- **問題**: `IS_DEVELOPMENT_STAGE = true`がハードコーディング
- **対策**: 環境変数を使用

#### 3. 本番環境でのconsole.log
- **場所**: `/src/lib/api.ts`全体
- **問題**: 機密情報がログに出力される可能性
- **対策**: 開発環境のみでログ出力するよう修正

#### 4. パフォーマンスの問題
- **場所**: `/src/components/VotingCard.tsx:125-148`
- **問題**: ヘルパー関数が再レンダリングごとに再作成
- **対策**: `useMemo`の使用

### バックエンド

#### 1. エラーハンドリングの不足
- **場所**: `/gas-files/main.gs`
- **問題**: 詳細なエラー情報の欠如
- **対策**: 構造化されたエラーログの実装

#### 2. データベース操作の非効率性
- **場所**: `/gas-files/database.gs:223-248`
- **問題**: 全行をループする O(n) の処理
- **対策**: インデックスやクエリ関数の使用

## ⚠️ 中優先度の問題

### アクセシビリティ

1. **ARIAラベルの欠如**
   - モーダル、ローディングスピナー、タブナビゲーションに適切なARIA属性なし

2. **キーボードナビゲーション**
   - モーダルのフォーカストラップなし
   - Escapeキーでの閉じる機能なし

### UI/UX

1. **一貫性のないローディング表示**
   - 異なるコンポーネントで異なるローディングUI

2. **エラーメッセージの表示方法**
   - `alert()`の使用（`/src/components/VotingCard.tsx:49-68`）
   - より良いUIコンポーネントへの置き換えが必要

### 型安全性

1. **過度に寛容な型定義**
   - `/src/lib/types.ts:36`: `[key: string]: unknown`

2. **型アサーションの過度な使用**
   - `/src/lib/api.ts:363`: `unknown`型のキャスト

## 📋 推奨アクション

### 即座に対応すべき項目

1. **セキュリティ**
   - [ ] APIエンドポイントに認証機能を実装
   - [ ] CORS設定を特定ドメインのみに制限
   - [ ] 環境変数の適切な使用
   - [ ] `isValidEmail`関数の実装

2. **コード品質**
   - [ ] 重複ファイルの削除
   - [ ] console.logの条件付き出力
   - [ ] 開発フラグを環境変数に移行

### 短期的な改善項目

1. **パフォーマンス**
   - [ ] React.memoとuseMemoの適切な使用
   - [ ] データベースクエリの最適化

2. **アクセシビリティ**
   - [ ] ARIA属性の追加
   - [ ] キーボードナビゲーションの改善

3. **エラーハンドリング**
   - [ ] 構造化されたエラーログ
   - [ ] ユーザーフレンドリーなエラーメッセージ

### 長期的な改善項目

1. **アーキテクチャ**
   - [ ] 適切なデータベースの導入（Google Sheetsの代替）
   - [ ] 状態管理ライブラリの導入
   - [ ] APIバージョニング

2. **テスト**
   - [ ] ユニットテストの追加
   - [ ] E2Eテストの実装

3. **監視**
   - [ ] ロギングサービスの導入
   - [ ] パフォーマンス監視

## 🔍 セキュリティチェックリスト

- [ ] すべてのAPIエンドポイントに認証を実装
- [ ] 入力値のサニタイゼーション
- [ ] CORS設定の適切な制限
- [ ] 環境変数の使用
- [ ] セキュリティヘッダーの設定
- [ ] レート制限の実装
- [ ] SQLインジェクション対策
- [ ] XSS対策
- [ ] CSRF対策

## 📊 影響度評価

- **Critical**: 6件（即座の対応が必要）
- **High**: 8件（1週間以内に対応推奨）
- **Medium**: 10件（1ヶ月以内に対応推奨）
- **Low**: 5件（長期的な改善項目）

この文書は2025年6月20日時点のコードレビュー結果です。