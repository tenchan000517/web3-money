# WEB3 MONEY シミュレーションテスト計画書

**日付**: 2025年6月20日  
**目的**: 新アーキテクチャ実装前の要件実現可能性検証

---

## 🎯 テスト要件概要

### 検証すべき要件
1. **アクセス制御**: マイページからのみアクセス可能
2. **ページ分離**: プレミアム・ベーシック契約者で完全分離
3. **相互アクセス防止**: ベーシック↔プレミアム間の不正アクセス防止
4. **リファラー制御**: 同一ドメインから2つの異なるリンク（A・B）
5. **投票機能**: 両ページからの投票動作
6. **ポイント反映**: バックエンドでの重み計算（非表示）
7. **重複防止**: 同一ユーザーの重複投票制御
8. **接続安定性**: エラーハンドリングと接続テスト

---

## 🧪 シミュレーション環境設計

### 模擬元HPサイト設定
```html
<!-- 模擬レリモバサイト -->
<!DOCTYPE html>
<html>
<head>
    <title>レリモバお客様マイページ（模擬）</title>
</head>
<body>
    <h1>レリモバ お客様マイページ</h1>
    
    <!-- リファラーリンクA: ベーシック契約者用 -->
    <div class="basic-section">
        <h2>レリモバ基本契約者様</h2>
        <a href="http://localhost:3000/relay-basic" target="_blank">
            WEB3 MONEYサービスへ（基本契約者用）
        </a>
    </div>
    
    <!-- リファラーリンクB: プレミアム契約者用 -->
    <div class="premium-section">
        <h2>レリモバ+WEB3MONEY契約者様</h2>
        <a href="http://localhost:3000/relay-premium" target="_blank">
            WEB3 MONEYサービスへ（プレミアム契約者用）
        </a>
    </div>
</body>
</html>
```

### テストURL設定
- **模擬元HP**: `http://localhost:8080/customer/`（同一ドメイン）
- **WEB3 MONEY**: `http://localhost:3000/`

---

## 📋 テストケース詳細

### Test Case 1: アクセス制御テスト

#### TC1-1: 正常なリファラーアクセス
**目的**: 正しいリファラーからのアクセス確認
```
前提条件: 模擬マイページを開く
手順:
1. 「基本契約者用リンク」をクリック
2. /relay-basic ページに遷移することを確認
3. 「プレミアム契約者用リンク」をクリック  
4. /relay-premium ページに遷移することを確認

期待結果:
- 両リンクとも正常にアクセス可能
- 適切なrelayページに遷移
- アクセス成功メッセージ表示
```

#### TC1-2: 直接アクセス拒否テスト
**目的**: 直接アクセスの拒否確認
```
手順:
1. ブラウザで直接 http://localhost:3000/relay-basic にアクセス
2. ブラウザで直接 http://localhost:3000/relay-premium にアクセス
3. ブラウザで直接 http://localhost:3000/main-basic にアクセス
4. ブラウザで直接 http://localhost:3000/main-premium にアクセス

期待結果:
- 全てアクセス拒否
- 適切なエラーメッセージ表示
- 正しいアクセス方法の案内表示
```

#### TC1-3: 不正リファラー拒否テスト
**目的**: 不正なリファラーからの拒否確認
```
手順:
1. Google検索結果から模擬的にアクセス
2. 他のサイトからリンクを模擬
3. ブックマークからのアクセス

期待結果:
- 全てアクセス拒否
- リファラー不正エラー表示
```

### Test Case 2: ページ分離テスト

#### TC2-1: ページ独立性確認
**目的**: 各ページが独立して動作することを確認
```
手順:
1. basic契約者としてログイン → /main-basic 到達
2. premium契約者としてログイン → /main-premium 到達
3. 両ページの表示内容が同一であることを確認
4. 両ページのURL が異なることを確認

期待結果:
- 同一コンテンツ表示
- 異なるURL
- 異なる背景色（basic: 白、premium: 黒）
```

#### TC2-2: 相互アクセス防止テスト
**目的**: basic↔premium間の不正アクセス防止
```
手順:
1. basic契約者で /main-basic にアクセス
2. URL手動変更で /main-premium にアクセス試行
3. premium契約者で /main-premium にアクセス  
4. URL手動変更で /main-basic にアクセス試行

期待結果:
- URL手動変更によるアクセスは拒否
- 適切な認証画面にリダイレクト
- セッション情報による制御
```

### Test Case 3: 投票機能テスト

#### TC3-1: 両ページからの投票テスト
**目的**: basic/premiumページから正常に投票できることを確認
```
テストユーザー: test@example.com

手順:
1. basicページから投票実行
   - 名前: テストユーザー1
   - メール: test@example.com
   - 対象候補: 候補A
   
2. premiumページから投票実行
   - 名前: テストユーザー1  
   - メール: test@example.com
   - 対象候補: 候補A
   - YouTube出演: 希望する

期待結果:
- 両ページから投票成功
- エラーなしで完了
- 投票完了メッセージ表示
```

#### TC3-2: ポイント反映テスト（バックエンド）
**目的**: 投票権重がバックエンドで正しく計算されることを確認
```
検証方法:
1. Google Sheetsを直接確認
2. 管理画面での集計確認
3. GAS ログでの計算過程確認

期待結果:
- basic投票: weight = 1 で記録
- premium投票: weight = 5 で記録
- 合計: 6ポイント（非表示）
- UI上では総票数のみ表示（6票として表示）
```

#### TC3-3: 重複投票防止テスト
**目的**: 同一ユーザーの重複投票が防止されることを確認
```
テストパターン:
1. 同一ページでの重複投票試行
   - basicページで2回目の投票試行
   - premiumページで2回目の投票試行
   
2. 異なるメールアドレスでの投票試行
   - test@example.com (1回目)
   - test2@example.com (別ユーザー)

期待結果:
- 同一ページ・同一メールでの2回目投票は拒否
- 異なるメールアドレスは許可
- 適切なエラーメッセージ表示
```

### Test Case 4: 接続安定性テスト

#### TC4-1: Google Sheets接続テスト
**目的**: プライベートスプレッドシートとの接続安定性確認
```
手順:
1. 投票データ送信
2. ネットワーク遅延シミュレーション
3. 大量データ送信テスト
4. 同時接続テスト

期待結果:
- 安定したデータ送信
- タイムアウト時の適切なエラーハンドリング
- データ整合性の維持
```

#### TC4-2: エラーハンドリングテスト
**目的**: 各種エラー状況での適切な処理確認
```
エラーパターン:
1. Google Sheets接続エラー
2. 不正なデータ形式送信
3. ネットワーク切断
4. サーバータイムアウト

期待結果:
- ユーザーフレンドリーなエラーメッセージ
- データ損失の防止
- 適切な再試行機能
```

---

## 🔧 シミュレーション実装手順

### Step 1: 模擬環境構築
```bash
# 1. 模擬マイページサーバー起動
cd mock-customer-site
python -m http.server 8080

# 2. WEB3 MONEY開発サーバー起動  
cd web3-money
npm run dev
```

### Step 2: テスト用データ準備
```javascript
// テスト用ユーザーデータ
const testUsers = [
  {
    name: "テストユーザー基本",
    email: "basic@test.com", 
    financeId: "BASIC001"
  },
  {
    name: "テストユーザープレミアム",
    email: "premium@test.com",
    financeId: "PREMIUM001"  
  }
];
```

### Step 3: テスト実行環境
- **ブラウザ**: Chrome, Firefox, Safari
- **デバイス**: PC, スマートフォン, タブレット
- **ネットワーク**: 高速回線, モバイル回線

---

## 📊 成功基準

### 必須クリア項目
- [ ] リファラーチェックによるアクセス制御
- [ ] ページ分離と相互アクセス防止
- [ ] 投票機能の正常動作
- [ ] 重複投票の完全防止
- [ ] ポイント重みの完全隠蔽
- [ ] 接続安定性の確保

### 推奨クリア項目
- [ ] ユーザビリティの確保
- [ ] エラーメッセージの分かりやすさ
- [ ] パフォーマンスの維持

---

## 🚨 テスト失敗時の対応

### クリティカル失敗
- **アクセス制御不備**: アーキテクチャ再設計
- **投票データ不整合**: データフロー見直し
- **重複投票防止失敗**: 認証システム強化

### 軽微な失敗
- **UI/UX問題**: インターフェース調整
- **エラーメッセージ**: 文言修正
- **パフォーマンス**: 最適化実施

---

このシミュレーションテスト計画に沿って検証を実施し、全項目クリア後に実装に進みます。テスト開始しますか？