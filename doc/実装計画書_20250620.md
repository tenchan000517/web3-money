# WEB3 MONEY リアーキテクチャ実装計画書

**日付**: 2025年6月20日  
**目的**: プライバシー保護と情報漏洩防止を重視した新アーキテクチャの実装

---

## 🚨 現在の重大な問題

### 1. 情報漏洩リスク
- `VotingPageSelector.tsx`で投票権重を明示（1ポイント/5ポイント）
- 「強化投票権」表記で重みの違いを示唆
- ユーザーが投票ページを選択できる設計

### 2. アーキテクチャ問題
- 契約者情報を持っていないにも関わらず判別機能を想定
- スプレッドシート共有によるプライバシーリスク

---

## 🎯 新アーキテクチャ設計

### アクセスフロー設計
```
レリモバサイト
├── 基本契約者用リンク → /relay-basic → /main-basic
└── プレミアム契約者用リンク → /relay-premium → /main-premium
```

### ページ構成
- **`/relay-basic`**: 基本契約者専用アクセス確認ページ
- **`/relay-premium`**: プレミアム契約者専用アクセス確認ページ
- **`/main-basic`**: 基本契約者専用メインページ
- **`/main-premium`**: プレミアム契約者専用メインページ

### 重要な設計原則
1. **コンテンツ統一**: 両mainページは同一のお知らせ・情報を表示
2. **投票権重隠蔽**: UI上で一切の重み情報を表示しない
3. **契約判別**: リファラーチェックのみで判別
4. **投票制御**: メールアドレスベースで重複制御

---

## 📊 データフロー設計

### 投票システム
```
ユーザー投票
    ↓
メールアドレス + ページ情報で記録
    ↓
プライベートスプレッドシート（専用GAS）
    ↓
- どのページからの投票か記録
- 重複投票チェック
- 重み計算（バックエンドのみ）
```

### 投票制御ルール
- **基本ページ**: 1回投票可能（重み1、非表示）
- **プレミアムページ**: 1回投票可能（重み5、非表示）
- **最大投票数**: 1ユーザー2回（合計6ポイント、非表示）

---

## 🔐 プライバシー保護戦略

### プライベートスプレッドシート設計
- **共有設定**: 完全プライベート（非共有）
- **アクセス方法**: 専用Google Apps Script経由のみ
- **データ保護**: 重み情報はGAS内でのみ処理

### 専用GAS機能
- 投票データの受信・保存
- メールアドレスベースの重複チェック
- 投票ページ別の集計
- 重み計算（フロントエンドには非送信）

---

## 📋 実装タスク詳細

### Phase 1: 緊急対応（即時実行）
#### 1.1 情報漏洩防止
- [ ] `VotingPageSelector.tsx`の完全削除
- [ ] 全UIから投票権重・ポイント表記の削除
- [ ] 「強化投票権」等の示唆的表現の削除

#### 1.2 ページ構造変更
- [ ] `/relay-basic`ページの作成
- [ ] `/relay-premium`ページの作成
- [ ] 既存`/relay`ページの廃止検討

### Phase 2: 新メインページ実装
#### 2.1 基本ページ
- [ ] `/main-basic`ページの作成
- [ ] 白背景デザインの実装
- [ ] 基本投票機能の実装

#### 2.2 プレミアムページ  
- [ ] `/main-premium`ページの作成
- [ ] 黒背景デザインの実装
- [ ] プレミアム投票機能（YouTube選択含む）の実装

#### 2.3 コンテンツ統一
- [ ] 両ページで同一のお知らせ表示
- [ ] 共通コンポーネントの設計・実装

### Phase 3: バックエンド再設計
#### 3.1 プライベートスプレッドシート
- [ ] 新しいプライベートスプレッドシートの作成
- [ ] 専用Google Apps Scriptの実装
- [ ] 投票データスキーマの設計

#### 3.2 投票システム改修
- [ ] メールアドレスベース投票管理
- [ ] ページ別投票制御
- [ ] 重み計算のバックエンド移行

### Phase 4: 統合テスト
#### 4.1 機能テスト
- [ ] 各ページからの投票動作確認
- [ ] 重複投票防止の確認
- [ ] データ保存・集計の確認

#### 4.2 セキュリティテスト
- [ ] 情報漏洩チェック
- [ ] 不正アクセス防止確認
- [ ] プライバシー保護確認

---

## 🛠 技術実装詳細

### 新しいファイル構成
```
src/
├── app/
│   ├── relay-basic/
│   │   └── page.tsx          # 基本契約者用認証
│   ├── relay-premium/
│   │   └── page.tsx          # プレミアム契約者用認証
│   ├── main-basic/
│   │   └── page.tsx          # 基本契約者用メイン
│   └── main-premium/
│       └── page.tsx          # プレミアム契約者用メイン
├── components/
│   ├── MainPageContent.tsx   # 共通メインコンテンツ
│   ├── VotingModal.tsx       # 投票モーダル（改修）
│   └── [削除] VotingPageSelector.tsx
```

### リファラー設定
```typescript
// relay-basic/page.tsx
const allowedReferrers = [
  'xmobile.ne.jp/customer/basic',
  'xmobile.ne.jp/basic-plan'
];

// relay-premium/page.tsx  
const allowedReferrers = [
  'xmobile.ne.jp/customer/premium',
  'xmobile.ne.jp/web3money'
];
```

### 投票データ構造
```typescript
interface VoteData {
  email: string;
  name: string;
  financeId: string;
  campaignId: string;
  applicantId: string;
  votePage: 'basic' | 'premium';
  youtubeOptIn?: boolean;
  votedAt: string;
  // 重みはGAS内でのみ処理、フロントエンドには送信しない
}
```

---

## ⚠️ リスク管理

### 高リスク項目
1. **既存投票データ**: 移行時のデータ整合性
2. **URL変更**: SEOとブックマークへの影響
3. **スプレッドシート移行**: データ損失リスク

### 対策
- [ ] 既存データのバックアップ
- [ ] 段階的移行による影響最小化
- [ ] 十分なテスト期間の確保

---

## 📅 実装スケジュール

### Week 1: 緊急対応
- Day 1-2: 情報漏洩箇所の削除
- Day 3-5: 新relay・mainページの基本実装

### Week 2: バックエンド実装
- Day 1-3: プライベートスプレッドシート・GAS実装
- Day 4-5: 投票システム統合

### Week 3: テスト・調整
- Day 1-3: 機能・セキュリティテスト
- Day 4-5: 最終調整・デプロイ準備

---

## ✅ 成功基準

### 機能要件
- [ ] 投票権重情報の完全隠蔽
- [ ] 両ページからの独立した投票
- [ ] メールベースの重複制御
- [ ] 同一コンテンツの提供

### セキュリティ要件
- [ ] プライバシー情報の完全保護
- [ ] 不正投票の防止
- [ ] 情報漏洩の根絶

### パフォーマンス要件
- [ ] 既存と同等の応答速度
- [ ] 安定したデータ保存
- [ ] スムーズなユーザー体験

---

この計画書に基づいて実装を開始しますか？優先度の高いタスクから順次対応していきます。