# WEB3 MONEY システム完全実装計画書【コード付き】

## 📁 プロジェクト構成

### フロントエンド (Next.js)
```
web3-money/
├── src/
│   ├── app/
│   │   ├── page.tsx                 # ホームページ
│   │   ├── relay/page.tsx           # リレイヤーページ
│   │   ├── main/page.tsx            # メインページ
│   │   ├── admin/
│   │   │   ├── page.tsx            # 管理ダッシュボード
│   │   │   ├── notices/page.tsx    # お知らせ管理
│   │   │   └── campaigns/page.tsx  # キャンペーン管理
│   │   ├── layout.tsx              # レイアウト
│   │   └── globals.css            # グローバルスタイル
│   ├── components/
│   │   ├── NoticeList.tsx          # お知らせ一覧
│   │   ├── CampaignTabs.tsx        # キャンペーンタブ
│   │   ├── VotingCard.tsx          # 投票カード
│   │   └── AdminLayout.tsx         # 管理画面レイアウト
│   ├── lib/
│   │   ├── api.ts                  # API通信
│   │   └── types.ts                # 型定義
│   └── hooks/
│       ├── useNotices.ts           # お知らせフック
│       └── useCampaigns.ts         # キャンペーンフック
├── package.json
├── tailwind.config.js
└── next.config.js
```

### バックエンド (Google Apps Script)
```
GAS Project/
├── main.gs                         # メインAPI
├── notices.gs                      # お知らせ機能
├── campaigns.gs                    # キャンペーン機能
├── votes.gs                        # 投票機能
├── forms.gs                        # フォーム連携
├── database.gs                     # データベース操作
└── utils.gs                        # ユーティリティ
```

## 🚀 Phase 1-2: 基盤構築（2週間）

### プロジェクトセットアップ

#### package.json
```json
{
  "name": "web3-money",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "next": "14.0.0",
    "react": "^18",
    "react-dom": "^18",
    "typescript": "^5",
    "@types/node": "^20",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "tailwindcss": "^3.3.0",
    "autoprefixer": "^10.0.1",
    "postcss": "^8",
    "axios": "^1.6.0",
    "date-fns": "^2.30.0"
  }
}
```

#### 型定義 (src/lib/types.ts)
```typescript
export interface Notice {
  id: string;
  title: string;
  content: string;
  startDate: string;
  endDate: string;
  createdAt: string;
}

export interface Campaign {
  id: string;
  title: string;
  formUrl: string;
  sheetUrl: string;
  status: 'draft' | 'active' | 'ended' | 'archived';
  startDate: string;
  endDate: string;
  createdAt: string;
  fields: FormField[];
}

export interface FormField {
  key: string;
  displayName: string;
  type: 'text' | 'number' | 'date';
  visible: boolean;
  order: number;
}

export interface Applicant {
  id: string;
  campaignId: string;
  voteCount: number;
  [key: string]: any; // 動的項目
}

export interface Vote {
  id: string;
  campaignId: string;
  applicantId: string;
  voteCount: number;
  updatedAt: string;
}

export interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: string;
  message?: string;
}
```

#### API通信 (src/lib/api.ts)
```typescript
import axios from 'axios';
import { Notice, Campaign, Applicant, ApiResponse } from './types';

const API_BASE_URL = process.env.NEXT_PUBLIC_GAS_API_URL;

const api = axios.create({
  baseURL: API_BASE_URL,
  timeout: 30000,
});

// お知らせAPI
export const getNotices = async (): Promise<Notice[]> => {
  const response = await api.get<ApiResponse<Notice[]>>('?path=notices');
  if (response.data.success) {
    return response.data.data || [];
  }
  throw new Error(response.data.error || 'Failed to fetch notices');
};

export const createNotice = async (notice: Omit<Notice, 'id' | 'createdAt'>): Promise<Notice> => {
  const response = await api.post<ApiResponse<Notice>>('?path=notices', notice);
  if (response.data.success) {
    return response.data.data!;
  }
  throw new Error(response.data.error || 'Failed to create notice');
};

// キャンペーンAPI
export const getCampaigns = async (status?: string): Promise<Campaign[]> => {
  const url = status ? `?path=campaigns&status=${status}` : '?path=campaigns';
  const response = await api.get<ApiResponse<Campaign[]>>(url);
  if (response.data.success) {
    return response.data.data || [];
  }
  throw new Error(response.data.error || 'Failed to fetch campaigns');
};

export const getCampaign = async (id: string): Promise<Campaign & { applicants: Applicant[] }> => {
  const response = await api.get<ApiResponse<Campaign & { applicants: Applicant[] }>>(`?path=campaign&id=${id}`);
  if (response.data.success) {
    return response.data.data!;
  }
  throw new Error(response.data.error || 'Failed to fetch campaign');
};

export const createCampaign = async (campaign: Omit<Campaign, 'id' | 'createdAt' | 'status'>): Promise<Campaign> => {
  const response = await api.post<ApiResponse<Campaign>>('?path=campaigns', campaign);
  if (response.data.success) {
    return response.data.data!;
  }
  throw new Error(response.data.error || 'Failed to create campaign');
};

export const updateCampaignStatus = async (id: string, status: Campaign['status']): Promise<void> => {
  const response = await api.put<ApiResponse<void>>(`?path=campaigns&id=${id}`, { status });
  if (!response.data.success) {
    throw new Error(response.data.error || 'Failed to update campaign status');
  }
};

// 投票API
export const addVote = async (campaignId: string, applicantId: string): Promise<void> => {
  const response = await api.post<ApiResponse<void>>('?path=votes', { campaignId, applicantId });
  if (!response.data.success) {
    throw new Error(response.data.error || 'Failed to add vote');
  }
};

// フォーム連携API
export const testFormConnection = async (sheetUrl: string): Promise<any> => {
  const response = await api.post<ApiResponse<any>>('?path=test-connection', { sheetUrl });
  return response.data;
};

export const getFormFields = async (sheetUrl: string): Promise<any> => {
  const response = await api.post<ApiResponse<any>>('?path=form-fields', { sheetUrl });
  return response.data;
};
```

### 基本ページ実装

#### ホームページ (src/app/page.tsx)
```typescript
import Link from 'next/link';

export default function HomePage() {
  return (
    <div className="min-h-screen bg-gradient-to-b from-blue-50 to-white">
      <div className="container mx-auto px-4 py-16">
        <div className="text-center mb-12">
          <h1 className="text-4xl font-bold text-gray-800 mb-4">
            WEB3 MONEY
          </h1>
          <p className="text-xl text-gray-600 mb-8">
            レリモバ契約者専用サービス
          </p>
          <div className="bg-white rounded-lg shadow-lg p-8 max-w-2xl mx-auto">
            <h2 className="text-2xl font-semibold mb-4">サービス内容</h2>
            <ul className="text-left space-y-3 text-gray-700">
              <li>• お知らせの配信</li>
              <li>• 支援金投票システム</li>
              <li>• レリモバ契約者限定コンテンツ</li>
            </ul>
            <div className="mt-8">
              <Link 
                href="/relay"
                className="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors inline-block"
              >
                サービスを利用する
              </Link>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
```

#### リレイヤーページ (src/app/relay/page.tsx)
```typescript
'use client';
import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';

export default function RelayPage() {
  const router = useRouter();
  const [status, setStatus] = useState<'checking' | 'success' | 'error'>('checking');

  useEffect(() => {
    const checkReferrer = () => {
      const allowedReferrers = [
        'xmobile.ne.jp/customer/',
        'xmobile.ne.jp/thanks/',
        'localhost', // 開発用
      ];

      const referrer = document.referrer;
      const isAllowed = allowedReferrers.some(allowed => 
        referrer.includes(allowed)
      );

      if (isAllowed || process.env.NODE_ENV === 'development') {
        setStatus('success');
        setTimeout(() => {
          router.push('/main');
        }, 2000);
      } else {
        setStatus('error');
      }
    };

    checkReferrer();
  }, [router]);

  if (status === 'checking') {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">アクセス確認中...</p>
        </div>
      </div>
    );
  }

  if (status === 'success') {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <p className="text-gray-600">認証成功！リダイレクト中...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="text-center max-w-md mx-auto p-8">
        <div className="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        </div>
        <h2 className="text-xl font-semibold mb-2">アクセスが拒否されました</h2>
        <p className="text-gray-600 mb-4">
          このページはレリモバお客様マイページからのアクセスのみ許可されています。
        </p>
        <button 
          onClick={() => window.history.back()}
          className="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700"
        >
          戻る
        </button>
      </div>
    </div>
  );
}
```

## 🔔 Phase 3: お知らせ機能（1週間）

#### お知らせ一覧コンポーネント (src/components/NoticeList.tsx)
```typescript
'use client';
import { useEffect, useState } from 'react';
import { Notice } from '@/lib/types';
import { getNotices } from '@/lib/api';
import { format } from 'date-fns';
import { ja } from 'date-fns/locale';

export default function NoticeList() {
  const [notices, setNotices] = useState<Notice[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchNotices = async () => {
      try {
        const data = await getNotices();
        setNotices(data);
      } catch (error) {
        console.error('Failed to fetch notices:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchNotices();
  }, []);

  if (loading) {
    return (
      <div className="space-y-4">
        {[1, 2, 3].map(i => (
          <div key={i} className="bg-white rounded-lg shadow p-6 animate-pulse">
            <div className="h-4 bg-gray-200 rounded mb-2"></div>
            <div className="h-3 bg-gray-200 rounded w-3/4"></div>
          </div>
        ))}
      </div>
    );
  }

  if (notices.length === 0) {
    return (
      <div className="text-center py-12">
        <p className="text-gray-500">現在お知らせはありません</p>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {notices.map((notice) => (
        <div key={notice.id} className="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow">
          <div className="p-6">
            <h3 className="text-lg font-semibold text-gray-800 mb-3">
              {notice.title}
            </h3>
            <div className="text-gray-600 mb-4 whitespace-pre-wrap">
              {notice.content}
            </div>
            <div className="flex justify-between text-sm text-gray-500">
              <span>投稿日: {format(new Date(notice.createdAt), 'yyyy年M月d日', { locale: ja })}</span>
              <span>期限: {format(new Date(notice.endDate), 'yyyy年M月d日', { locale: ja })}</span>
            </div>
          </div>
        </div>
      ))}
    </div>
  );
}
```

#### お知らせ管理画面 (src/app/admin/notices/page.tsx)
```typescript
'use client';
import { useState, useEffect } from 'react';
import { Notice } from '@/lib/types';
import { getNotices, createNotice, updateNotice, deleteNotice } from '@/lib/api';

export default function NoticesAdmin() {
  const [notices, setNotices] = useState<Notice[]>([]);
  const [isEditing, setIsEditing] = useState(false);
  const [editingNotice, setEditingNotice] = useState<Partial<Notice>>({});
  const [loading, setLoading] = useState(false);

  const [formData, setFormData] = useState({
    title: '',
    content: '',
    startDate: new Date().toISOString().split('T')[0],
    endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
  });

  useEffect(() => {
    fetchNotices();
  }, []);

  const fetchNotices = async () => {
    try {
      const data = await getNotices();
      setNotices(data);
    } catch (error) {
      console.error('Failed to fetch notices:', error);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    
    try {
      if (isEditing && editingNotice.id) {
        await updateNotice(editingNotice.id, formData);
      } else {
        await createNotice(formData);
      }
      
      await fetchNotices();
      resetForm();
      alert('お知らせを保存しました');
    } catch (error) {
      console.error('Failed to save notice:', error);
      alert('保存に失敗しました');
    } finally {
      setLoading(false);
    }
  };

  const handleEdit = (notice: Notice) => {
    setIsEditing(true);
    setEditingNotice(notice);
    setFormData({
      title: notice.title,
      content: notice.content,
      startDate: notice.startDate.split('T')[0],
      endDate: notice.endDate.split('T')[0]
    });
  };

  const handleDelete = async (id: string) => {
    if (!confirm('本当に削除しますか？')) return;
    
    try {
      await deleteNotice(id);
      await fetchNotices();
      alert('お知らせを削除しました');
    } catch (error) {
      console.error('Failed to delete notice:', error);
      alert('削除に失敗しました');
    }
  };

  const resetForm = () => {
    setIsEditing(false);
    setEditingNotice({});
    setFormData({
      title: '',
      content: '',
      startDate: new Date().toISOString().split('T')[0],
      endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
    });
  };

  return (
    <div className="max-w-4xl mx-auto p-6">
      <h1 className="text-2xl font-bold mb-6">お知らせ管理</h1>
      
      {/* フォーム */}
      <div className="bg-white rounded-lg shadow p-6 mb-6">
        <h2 className="text-lg font-semibold mb-4">
          {isEditing ? 'お知らせ編集' : '新規お知らせ'}
        </h2>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              タイトル
            </label>
            <input
              type="text"
              value={formData.title}
              onChange={(e) => setFormData({...formData, title: e.target.value})}
              className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              内容
            </label>
            <textarea
              value={formData.content}
              onChange={(e) => setFormData({...formData, content: e.target.value})}
              rows={6}
              className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                開始日
              </label>
              <input
                type="date"
                value={formData.startDate}
                onChange={(e) => setFormData({...formData, startDate: e.target.value})}
                className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                終了日
              </label>
              <input
                type="date"
                value={formData.endDate}
                onChange={(e) => setFormData({...formData, endDate: e.target.value})}
                className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                required
              />
            </div>
          </div>

          <div className="flex gap-2">
            <button
              type="submit"
              disabled={loading}
              className="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50"
            >
              {loading ? '保存中...' : (isEditing ? '更新' : '作成')}
            </button>
            
            {isEditing && (
              <button
                type="button"
                onClick={resetForm}
                className="bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-700 transition-colors"
              >
                キャンセル
              </button>
            )}
          </div>
        </form>
      </div>

      {/* 一覧 */}
      <div className="bg-white rounded-lg shadow">
        <div className="p-6">
          <h2 className="text-lg font-semibold mb-4">お知らせ一覧</h2>
          
          {notices.length === 0 ? (
            <p className="text-gray-500 text-center py-8">お知らせがありません</p>
          ) : (
            <div className="space-y-4">
              {notices.map((notice) => (
                <div key={notice.id} className="border border-gray-200 rounded-lg p-4">
                  <div className="flex justify-between items-start mb-2">
                    <h3 className="font-semibold">{notice.title}</h3>
                    <div className="flex gap-2">
                      <button
                        onClick={() => handleEdit(notice)}
                        className="text-blue-600 hover:text-blue-800 text-sm"
                      >
                        編集
                      </button>
                      <button
                        onClick={() => handleDelete(notice.id)}
                        className="text-red-600 hover:text-red-800 text-sm"
                      >
                        削除
                      </button>
                    </div>
                  </div>
                  <p className="text-gray-600 text-sm mb-2 line-clamp-2">
                    {notice.content}
                  </p>
                  <div className="flex justify-between text-xs text-gray-500">
                    <span>{notice.startDate} ～ {notice.endDate}</span>
                    <span>{notice.createdAt}</span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
```

## 🗳️ Phase 4-5: 投票システム（1.5週間）

#### キャンペーンタブコンポーネント (src/components/CampaignTabs.tsx)
```typescript
'use client';
import { useState, useEffect } from 'react';
import { Campaign, Applicant } from '@/lib/types';
import { getCampaigns, getCampaign } from '@/lib/api';
import VotingCard from './VotingCard';

export default function CampaignTabs() {
  const [activeCampaigns, setActiveCampaigns] = useState<Campaign[]>([]);
  const [selectedCampaign, setSelectedCampaign] = useState<string | null>(null);
  const [campaignData, setCampaignData] = useState<(Campaign & { applicants: Applicant[] }) | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchActiveCampaigns();
  }, []);

  useEffect(() => {
    if (selectedCampaign) {
      fetchCampaignData(selectedCampaign);
    }
  }, [selectedCampaign]);

  const fetchActiveCampaigns = async () => {
    try {
      const campaigns = await getCampaigns('active');
      setActiveCampaigns(campaigns);
      
      // 最初のキャンペーンを自動選択
      if (campaigns.length > 0) {
        setSelectedCampaign(campaigns[0].id);
      }
    } catch (error) {
      console.error('Failed to fetch campaigns:', error);
    } finally {
      setLoading(false);
    }
  };

  const fetchCampaignData = async (campaignId: string) => {
    try {
      const data = await getCampaign(campaignId);
      setCampaignData(data);
    } catch (error) {
      console.error('Failed to fetch campaign data:', error);
    }
  };

  if (loading) {
    return (
      <div className="flex justify-center py-12">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  if (activeCampaigns.length === 0) {
    return (
      <div className="text-center py-12">
        <p className="text-gray-500">現在進行中の投票はありません</p>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* タブメニュー */}
      {activeCampaigns.length > 1 && (
        <div className="border-b border-gray-200">
          <nav className="-mb-px flex space-x-8 overflow-x-auto">
            {activeCampaigns.map((campaign) => (
              <button
                key={campaign.id}
                onClick={() => setSelectedCampaign(campaign.id)}
                className={`whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm transition-colors ${
                  selectedCampaign === campaign.id
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
              >
                {campaign.title}
              </button>
            ))}
          </nav>
        </div>
      )}

      {/* キャンペーン内容 */}
      {campaignData && (
        <div className="space-y-4">
          <div className="bg-white rounded-lg shadow p-6">
            <h2 className="text-xl font-bold mb-2">{campaignData.title}</h2>
            <div className="flex items-center gap-4 text-sm text-gray-600">
              <span>期間: {new Date(campaignData.startDate).toLocaleDateString()} ～ {new Date(campaignData.endDate).toLocaleDateString()}</span>
              <span className="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">
                投票中
              </span>
            </div>
            
            <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
              <p className="text-blue-800 text-sm">
                💡 お一人様1票でお願いします。重複投票はご遠慮ください。
              </p>
            </div>
          </div>

          {/* 申請者一覧 */}
          <div className="space-y-4">
            {campaignData.applicants.length === 0 ? (
              <div className="text-center py-12">
                <p className="text-gray-500">申請者がいません</p>
              </div>
            ) : (
              campaignData.applicants
                .sort((a, b) => (b.voteCount || 0) - (a.voteCount || 0))
                .map((applicant, index) => (
                  <VotingCard
                    key={applicant.id}
                    applicant={applicant}
                    campaignId={campaignData.id}
                    rank={index + 1}
                    onVoteSuccess={() => fetchCampaignData(campaignData.id)}
                  />
                ))
            )}
          </div>
        </div>
      )}
    </div>
  );
}
```

#### 投票カードコンポーネント (src/components/VotingCard.tsx)
```typescript
'use client';
import { useState } from 'react';
import { Applicant } from '@/lib/types';
import { addVote } from '@/lib/api';

interface VotingCardProps {
  applicant: Applicant;
  campaignId: string;
  rank: number;
  onVoteSuccess: () => void;
}

export default function VotingCard({ applicant, campaignId, rank, onVoteSuccess }: VotingCardProps) {
  const [voting, setVoting] = useState(false);
  const [hasVoted, setHasVoted] = useState(false);

  const handleVote = async () => {
    if (voting || hasVoted) return;

    setVoting(true);
    
    try {
      await addVote(campaignId, applicant.id);
      setHasVoted(true);
      onVoteSuccess();
      
      // 投票完了メッセージ
      alert('投票ありがとうございました！');
    } catch (error) {
      console.error('Failed to vote:', error);
      alert('投票に失敗しました。もう一度お試しください。');
    } finally {
      setVoting(false);
    }
  };

  const getRankEmoji = (rank: number) => {
    switch (rank) {
      case 1: return '🥇';
      case 2: return '🥈';
      case 3: return '🥉';
      default: return '';
    }
  };

  return (
    <div className="bg-white rounded-lg shadow hover:shadow-md transition-shadow">
      <div className="p-6">
        <div className="flex items-start justify-between mb-4">
          <div className="flex-1">
            <div className="flex items-center gap-3 mb-2">
              {rank <= 3 && (
                <span className="text-2xl">{getRankEmoji(rank)}</span>
              )}
              <h3 className="text-lg font-semibold">
                {applicant.name || applicant['お名前'] || applicant['氏名'] || `申請者${rank}`}
              </h3>
            </div>
            
            <div className="space-y-2 text-gray-600 mb-4">
              <p>
                <span className="font-medium">支援理由:</span> 
                <span className="ml-2">
                  {applicant.reason || applicant['支援理由'] || applicant['理由'] || '未記載'}
                </span>
              </p>
              <p>
                <span className="font-medium">希望金額:</span> 
                <span className="ml-2">
                  ¥{(applicant.amount || applicant['希望金額'] || applicant['金額'] || 0).toLocaleString()}
                </span>
              </p>
            </div>
            
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <span className="text-2xl">💖</span>
                <span className="font-semibold text-lg">
                  {applicant.voteCount || 0}票
                </span>
              </div>
              
              <button
                onClick={handleVote}
                disabled={voting || hasVoted}
                className={`px-6 py-2 rounded-lg font-medium transition-colors ${
                  hasVoted
                    ? 'bg-gray-100 text-gray-500 cursor-not-allowed'
                    : voting
                    ? 'bg-blue-300 text-white cursor-not-allowed'
                    : 'bg-blue-600 text-white hover:bg-blue-700'
                }`}
              >
                {hasVoted 
                  ? '応援済み' 
                  : voting 
                  ? '投票中...' 
                  : '💖 応援する'
                }
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
```

#### メインページ (src/app/main/page.tsx)
```typescript
'use client';
import { useState } from 'react';
import NoticeList from '@/components/NoticeList';
import CampaignTabs from '@/components/CampaignTabs';

export default function MainPage() {
  const [activeTab, setActiveTab] = useState<'notices' | 'voting'>('notices');

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="bg-white shadow-sm">
        <div className="container mx-auto px-4 py-4">
          <h1 className="text-2xl font-bold text-gray-800 mb-4">
            WEB3 MONEY
          </h1>
          
          <div className="flex border-b">
            <button
              onClick={() => setActiveTab('notices')}
              className={`px-6 py-3 font-medium border-b-2 transition-colors ${
                activeTab === 'notices'
                  ? 'border-blue-600 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}
            >
              お知らせ
            </button>
            <button
              onClick={() => setActiveTab('voting')}
              className={`px-6 py-3 font-medium border-b-2 transition-colors ${
                activeTab === 'voting'
                  ? 'border-blue-600 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}
            >
              支援金投票
            </button>
          </div>
        </div>
      </div>

      <div className="container mx-auto px-4 py-8">
        {activeTab === 'notices' && <NoticeList />}
        {activeTab === 'voting' && <CampaignTabs />}
      </div>
    </div>
  );
}
```

## 📝 Phase 6: フォーム連携・キャンペーン管理（1.5週間）

#### キャンペーン管理画面 (src/app/admin/campaigns/page.tsx)
```typescript
'use client';
import { useState, useEffect } from 'react';
import { Campaign, FormField } from '@/lib/types';
import { getCampaigns, createCampaign, updateCampaignStatus, testFormConnection, getFormFields } from '@/lib/api';

export default function CampaignsAdmin() {
  const [campaigns, setCampaigns] = useState<Campaign[]>([]);
  const [showForm, setShowForm] = useState(false);
  const [loading, setLoading] = useState(false);
  
  const [formData, setFormData] = useState({
    title: '',
    sheetUrl: '',
    startDate: new Date().toISOString().split('T')[0],
    endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
  });

  const [connectionTest, setConnectionTest] = useState<{
    status: 'idle' | 'testing' | 'success' | 'error';
    result?: any;
  }>({ status: 'idle' });

  const [formFields, setFormFields] = useState<FormField[]>([]);
  const [showFieldMapping, setShowFieldMapping] = useState(false);

  useEffect(() => {
    fetchCampaigns();
  }, []);

  const fetchCampaigns = async () => {
    try {
      const data = await getCampaigns();
      setCampaigns(data);
    } catch (error) {
      console.error('Failed to fetch campaigns:', error);
    }
  };

  const handleTestConnection = async () => {
    if (!formData.sheetUrl.trim()) {
      alert('スプレッドシートURLを入力してください');
      return;
    }

    setConnectionTest({ status: 'testing' });
    
    try {
      const result = await testFormConnection(formData.sheetUrl);
      
      if (result.success) {
        setConnectionTest({ status: 'success', result });
        
        // フィールド情報を取得
        const fieldsResult = await getFormFields(formData.sheetUrl);
        if (fieldsResult.success) {
          setFormFields(fieldsResult.fields.map((field: any, index: number) => ({
            key: field.key,
            displayName: field.key,
            type: field.type || 'text',
            visible: true,
            order: index
          })));
          setShowFieldMapping(true);
        }
      } else {
        setConnectionTest({ status: 'error', result });
      }
    } catch (error) {
      setConnectionTest({ 
        status: 'error', 
        result: { 
          success: false, 
          message: 'テストに失敗しました: ' + error 
        }
      });
    }
  };

  const renderConnectionGuide = () => {
    if (connectionTest.status !== 'error' || !connectionTest.result?.guide) return null;

    const guide = connectionTest.result.guide;
    
    return (
      <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
        <h4 className="font-semibold text-red-800 mb-2">{guide.title}</h4>
        <ol className="list-decimal list-inside space-y-1 text-sm text-red-700">
          {guide.steps.map((step: string, index: number) => (
            <li key={index}>{step}</li>
          ))}
        </ol>
        <button
          onClick={handleTestConnection}
          className="mt-3 bg-red-600 text-white px-4 py-2 rounded text-sm hover:bg-red-700"
        >
          再テスト
        </button>
      </div>
    );
  };

  const handleFieldUpdate = (index: number, field: Partial<FormField>) => {
    setFormFields(prev => 
      prev.map((f, i) => i === index ? { ...f, ...field } : f)
    );
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (connectionTest.status !== 'success') {
      alert('まず接続テストを実行してください');
      return;
    }

    setLoading(true);
    
    try {
      const campaignData = {
        ...formData,
        formUrl: '',
        fields: formFields
      };
      
      await createCampaign(campaignData);
      await fetchCampaigns();
      
      // フォームリセット
      setShowForm(false);
      resetForm();
      alert('キャンペーンを作成しました');
      
    } catch (error) {
      console.error('Failed to create campaign:', error);
      alert('キャンペーンの作成に失敗しました');
    } finally {
      setLoading(false);
    }
  };

  const resetForm = () => {
    setFormData({
      title: '',
      sheetUrl: '',
      startDate: new Date().toISOString().split('T')[0],
      endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
    });
    setConnectionTest({ status: 'idle' });
    setFormFields([]);
    setShowFieldMapping(false);
  };

  const handleStatusChange = async (campaignId: string, newStatus: Campaign['status']) => {
    if (!confirm(`キャンペーンを「${getStatusLabel(newStatus)}」に変更しますか？`)) return;
    
    try {
      await updateCampaignStatus(campaignId, newStatus);
      await fetchCampaigns();
      alert('ステータスを更新しました');
    } catch (error) {
      console.error('Failed to update status:', error);
      alert('ステータスの更新に失敗しました');
    }
  };

  const getStatusLabel = (status: Campaign['status']) => {
    switch (status) {
      case 'draft': return '準備中';
      case 'active': return '投票中';
      case 'ended': return '終了';
      case 'archived': return 'アーカイブ';
      default: return status;
    }
  };

  const getStatusColor = (status: Campaign['status']) => {
    switch (status) {
      case 'draft': return 'bg-yellow-100 text-yellow-800';
      case 'active': return 'bg-green-100 text-green-800';
      case 'ended': return 'bg-blue-100 text-blue-800';
      case 'archived': return 'bg-gray-100 text-gray-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  return (
    <div className="max-w-6xl mx-auto p-6">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">キャンペーン管理</h1>
        <button
          onClick={() => setShowForm(true)}
          className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
        >
          新規キャンペーン
        </button>
      </div>

      {showForm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-xl font-semibold">新規キャンペーン作成</h2>
              <button
                onClick={() => {
                  setShowForm(false);
                  resetForm();
                }}
                className="text-gray-500 hover:text-gray-700"
              >
                ✕
              </button>
            </div>

            <form onSubmit={handleSubmit} className="space-y-6">
              {/* 基本情報 */}
              <div className="space-y-4">
                <h3 className="text-lg font-medium">基本情報</h3>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    キャンペーン名
                  </label>
                  <input
                    type="text"
                    value={formData.title}
                    onChange={(e) => setFormData({...formData, title: e.target.value})}
                    className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    スプレッドシートURL
                  </label>
                  <input
                    type="url"
                    value={formData.sheetUrl}
                    onChange={(e) => setFormData({...formData, sheetUrl: e.target.value})}
                    placeholder="https://docs.google.com/spreadsheets/d/..."
                    className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    GoogleフォームのレスポンススプレッドシートのURLを入力してください
                  </p>
                </div>

                <div className="flex gap-2">
                  <button
                    type="button"
                    onClick={handleTestConnection}
                    disabled={connectionTest.status === 'testing'}
                    className={`px-4 py-2 rounded-md text-sm font-medium ${
                      connectionTest.status === 'testing'
                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                        : connectionTest.status === 'success'
                        ? 'bg-green-600 text-white'
                        : connectionTest.status === 'error'
                        ? 'bg-red-600 text-white'
                        : 'bg-blue-600 text-white hover:bg-blue-700'
                    }`}
                  >
                    {connectionTest.status === 'testing' ? '接続中...' :
                     connectionTest.status === 'success' ? '✓ 接続成功' :
                     connectionTest.status === 'error' ? '✗ 接続失敗' :
                     '接続テスト'}
                  </button>
                </div>

                {/* 接続結果表示 */}
                {connectionTest.result && (
                  <div className={`p-3 rounded-md ${
                    connectionTest.result.success ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'
                  }`}>
                    <p className={`text-sm ${
                      connectionTest.result.success ? 'text-green-800' : 'text-red-800'
                    }`}>
                      {connectionTest.result.message}
                    </p>
                    
                    {connectionTest.result.success && connectionTest.result.data && (
                      <div className="mt-2 text-xs text-green-700">
                        <p>シート名: {connectionTest.result.data.sheetName}</p>
                        <p>データ件数: {connectionTest.result.data.rowCount}件</p>
                        <p>項目数: {connectionTest.result.data.headers.length}個</p>
                      </div>
                    )}
                  </div>
                )}

                {renderConnectionGuide()}

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      開始日
                    </label>
                    <input
                      type="date"
                      value={formData.startDate}
                      onChange={(e) => setFormData({...formData, startDate: e.target.value})}
                      className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      終了日
                    </label>
                    <input
                      type="date"
                      value={formData.endDate}
                      onChange={(e) => setFormData({...formData, endDate: e.target.value})}
                      className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      required
                    />
                  </div>
                </div>
              </div>

              {/* フィールドマッピング */}
              {showFieldMapping && formFields.length > 0 && (
                <div className="border-t pt-6">
                  <h3 className="text-lg font-medium mb-4">項目設定</h3>
                  <p className="text-sm text-gray-600 mb-4">
                    検出された項目の表示設定を調整してください
                  </p>
                  
                  <div className="space-y-3">
                    {formFields.map((field, index) => (
                      <div key={field.key} className="border border-gray-200 rounded-lg p-4">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              元の項目名
                            </label>
                            <p className="text-sm bg-gray-50 p-2 rounded">{field.key}</p>
                          </div>
                          
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              表示名
                            </label>
                            <input
                              type="text"
                              value={field.displayName}
                              onChange={(e) => handleFieldUpdate(index, { displayName: e.target.value })}
                              className="w-full text-sm border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500"
                            />
                          </div>
                          
                          <div className="flex items-center gap-4">
                            <label className="flex items-center text-xs">
                              <input
                                type="checkbox"
                                checked={field.visible}
                                onChange={(e) => handleFieldUpdate(index, { visible: e.target.checked })}
                                className="mr-1"
                              />
                              表示
                            </label>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              <div className="flex gap-2 pt-4 border-t">
                <button
                  type="submit"
                  disabled={connectionTest.status !== 'success' || loading}
                  className={`px-6 py-2 rounded-md font-medium ${
                    connectionTest.status === 'success' && !loading
                      ? 'bg-blue-600 text-white hover:bg-blue-700'
                      : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  }`}
                >
                  {loading ? '作成中...' : 'キャンペーン作成'}
                </button>
                
                <button
                  type="button"
                  onClick={() => {
                    setShowForm(false);
                    resetForm();
                  }}
                  className="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700"
                >
                  キャンセル
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* キャンペーン一覧 */}
      <div className="bg-white rounded-lg shadow">
        <div className="p-6">
          <h2 className="text-lg font-semibold mb-4">キャンペーン一覧</h2>
          
          {campaigns.length === 0 ? (
            <p className="text-gray-500 text-center py-8">キャンペーンがありません</p>
          ) : (
            <div className="space-y-4">
              {campaigns.map((campaign) => (
                <div key={campaign.id} className="border border-gray-200 rounded-lg p-4">
                  <div className="flex justify-between items-start mb-2">
                    <div>
                      <h3 className="font-semibold mb-1">{campaign.title}</h3>
                      <div className="text-sm text-gray-600 space-y-1">
                        <p>期間: {campaign.startDate} ～ {campaign.endDate}</p>
                        <p>作成日: {new Date(campaign.createdAt).toLocaleDateString()}</p>
                      </div>
                    </div>
                    
                    <div className="flex items-center gap-2">
                      <span className={`px-2 py-1 rounded-full text-xs ${getStatusColor(campaign.status)}`}>
                        {getStatusLabel(campaign.status)}
                      </span>
                    </div>
                  </div>
                  
                  <div className="flex gap-2 mt-4">
                    {campaign.status === 'draft' && (
                      <button
                        onClick={() => handleStatusChange(campaign.id, 'active')}
                        className="text-green-600 hover:text-green-800 text-sm"
                      >
                        開始
                      </button>
                    )}
                    {campaign.status === 'active' && (
                      <button
                        onClick={() => handleStatusChange(campaign.id, 'ended')}
                        className="text-blue-600 hover:text-blue-800 text-sm"
                      >
                        終了
                      </button>
                    )}
                    {campaign.status === 'ended' && (
                      <button
                        onClick={() => handleStatusChange(campaign.id, 'archived')}
                        className="text-gray-600 hover:text-gray-800 text-sm"
                      >
                        アーカイブ
                      </button>
                    )}
                    <button className="text-blue-600 hover:text-blue-800 text-sm">
                      詳細
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
```

## 🔧 Google Apps Script実装

### メインAPI (main.gs)
```javascript
// WebApp エンドポイント
function doGet(e) {
  return handleRequest('GET', e.parameter);
}

function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  return handleRequest('POST', e.parameter, data);
}

function doPut(e) {
  const data = JSON.parse(e.postData.contents);
  return handleRequest('PUT', e.parameter, data);
}

function doDelete(e) {
  return handleRequest('DELETE', e.parameter);
}

function handleRequest(method, params, data = null) {
  try {
    let result;
    const path = params.path || '';
    
    // CORSヘッダー設定
    const response = ContentService.createTextOutput();
    response.setMimeType(ContentService.MimeType.JSON);
    
    switch(`${method}:${path}`) {
      // お知らせAPI
      case 'GET:notices':
        result = getNotices();
        break;
      case 'POST:notices':
        result = createNotice(data);
        break;
      case 'PUT:notices':
        result = updateNotice(params.id, data);
        break;
      case 'DELETE:notices':
        result = deleteNotice(params.id);
        break;
        
      // キャンペーンAPI
      case 'GET:campaigns':
        result = getCampaigns(params.status);
        break;
      case 'GET:campaign':
        result = getCampaignWithApplicants(params.id);
        break;
      case 'POST:campaigns':
        result = createCampaign(data);
        break;
      case 'PUT:campaigns':
        result = updateCampaignStatus(params.id, data.status);
        break;
        
      // 投票API
      case 'POST:votes':
        result = addVote(data.campaignId, data.applicantId);
        break;
        
      // フォーム連携API
      case 'POST:test-connection':
        result = testFormConnection(data.sheetUrl);
        break;
      case 'POST:form-fields':
        result = getFormFields(data.sheetUrl);
        break;
        
      default:
        throw new Error('Invalid endpoint: ' + method + ':' + path);
    }
    
    response.setContent(JSON.stringify({
      success: true,
      data: result
    }));
    
  } catch (error) {
    console.error('API Error:', error);
    response.setContent(JSON.stringify({
      success: false,
      error: error.toString(),
      message: error.message
    }));
  }
  
  return response;
}
```

### データベース操作 (database.gs)
```javascript
// スプレッドシート設定
const SHEET_ID = 'YOUR_SHEET_ID'; // 実際のスプレッドシートIDに置き換え

function getSheet(sheetName) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let sheet = ss.getSheetByName(sheetName);
  
  if (!sheet) {
    sheet = ss.insertSheet(sheetName);
    initializeSheet(sheet, sheetName);
  }
  
  return sheet;
}

function initializeSheet(sheet, sheetName) {
  switch(sheetName) {
    case 'notices':
      sheet.getRange(1, 1, 1, 6).setValues([[
        'ID', 'Title', 'Content', 'StartDate', 'EndDate', 'CreatedAt'
      ]]);
      break;
      
    case 'campaigns':
      sheet.getRange(1, 1, 1, 9).setValues([[
        'ID', 'Title', 'FormUrl', 'SheetUrl', 'Status', 'StartDate', 'EndDate', 'Fields', 'CreatedAt'
      ]]);
      break;
      
    case 'votes':
      sheet.getRange(1, 1, 1, 5).setValues([[
        'ID', 'CampaignId', 'ApplicantId', 'VoteCount', 'UpdatedAt'
      ]]);
      break;
  }
}

function generateId() {
  return Utilities.getUuid();
}

function getCurrentTimestamp() {
  return new Date().toISOString();
}

function arrayToObject(headers, row) {
  const obj = {};
  headers.forEach((header, index) => {
    obj[header.toLowerCase()] = row[index];
  });
  return obj;
}
```

### お知らせ機能 (notices.gs)
```javascript
function getNotices() {
  const sheet = getSheet('notices');
  const data = sheet.getDataRange().getValues();
  
  if (data.length <= 1) return [];
  
  const headers = data[0];
  const rows = data.slice(1);
  
  const now = new Date();
  
  return rows
    .map(row => arrayToObject(headers, row))
    .filter(notice => {
      const startDate = new Date(notice.startdate);
      const endDate = new Date(notice.enddate);
      return startDate <= now && now <= endDate;
    })
    .sort((a, b) => new Date(b.createdat) - new Date(a.createdat));
}

function createNotice(data) {
  const sheet = getSheet('notices');
  const id = generateId();
  const timestamp = getCurrentTimestamp();
  
  sheet.appendRow([
    id,
    data.title,
    data.content,
    data.startDate,
    data.endDate,
    timestamp
  ]);
  
  return { id, ...data, createdAt: timestamp };
}

function updateNotice(id, data) {
  const sheet = getSheet('notices');
  const values = sheet.getDataRange().getValues();
  
  for (let i = 1; i < values.length; i++) {
    if (values[i][0] === id) {
      sheet.getRange(i + 1, 2, 1, 4).setValues([[
        data.title,
        data.content,
        data.startDate,
        data.endDate
      ]]);
      return { id, ...data };
    }
  }
  
  throw new Error('Notice not found');
}

function deleteNotice(id) {
  const sheet = getSheet('notices');
  const values = sheet.getDataRange().getValues();
  
  for (let i = 1; i < values.length; i++) {
    if (values[i][0] === id) {
      sheet.deleteRow(i + 1);
      return { success: true };
    }
  }
  
  throw new Error('Notice not found');
}
```

### キャンペーン機能 (campaigns.gs)
```javascript
function getCampaigns(status) {
  const sheet = getSheet('campaigns');
  const data = sheet.getDataRange().getValues();
  
  if (data.length <= 1) return [];
  
  const headers = data[0];
  const rows = data.slice(1);
  
  let campaigns = rows.map(row => {
    const campaign = arrayToObject(headers, row);
    // Fields JSON文字列をパース
    if (campaign.fields) {
      try {
        campaign.fields = JSON.parse(campaign.fields);
      } catch (e) {
        campaign.fields = [];
      }
    }
    return campaign;
  });
  
  // ステータスフィルター
  if (status) {
    campaigns = campaigns.filter(c => c.status === status);
  }
  
  return campaigns.sort((a, b) => new Date(b.createdat) - new Date(a.createdat));
}

function getCampaignWithApplicants(campaignId) {
  const campaigns = getCampaigns();
  const campaign = campaigns.find(c => c.id === campaignId);
  
  if (!campaign) {
    throw new Error('Campaign not found');
  }
  
  // 申請者データを取得
  let applicants = [];
  if (campaign.sheeturl) {
    try {
      applicants = getApplicantsFromSheet(campaign.sheeturl, campaignId);
    } catch (error) {
      console.error('Failed to fetch applicants:', error);
    }
  }
  
  return { ...campaign, applicants };
}

function createCampaign(data) {
  const sheet = getSheet('campaigns');
  const id = generateId();
  const timestamp = getCurrentTimestamp();
  
  sheet.appendRow([
    id,
    data.title,
    data.formUrl || '',
    data.sheetUrl || '',
    'draft',
    data.startDate,
    data.endDate,
    JSON.stringify(data.fields || []),
    timestamp
  ]);
  
  return { id, ...data, status: 'draft', createdAt: timestamp };
}

function updateCampaignStatus(id, status) {
  const sheet = getSheet('campaigns');
  const values = sheet.getDataRange().getValues();
  
  for (let i = 1; i < values.length; i++) {
    if (values[i][0] === id) {
      sheet.getRange(i + 1, 5).setValue(status);
      return { success: true };
    }
  }
  
  throw new Error('Campaign not found');
}

function getApplicantsFromSheet(sheetUrl, campaignId) {
  try {
    const match = sheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    if (!match) {
      throw new Error('Invalid sheet URL');
    }
    
    const sheetId = match[1];
    const ss = SpreadsheetApp.openById(sheetId);
    const sheet = ss.getSheets()[0];
    
    const data = sheet.getDataRange().getValues();
    if (data.length <= 1) return [];
    
    const headers = data[0];
    const rows = data.slice(1);
    
    return rows.map((row, index) => {
      const applicant = { 
        id: `applicant_${campaignId}_${index}`,
        campaignId: campaignId
      };
      
      headers.forEach((header, headerIndex) => {
        applicant[header] = row[headerIndex];
      });
      
      // 投票数を取得
      applicant.voteCount = getVoteCount(campaignId, applicant.id);
      
      return applicant;
    });
    
  } catch (error) {
    console.error('Error fetching applicants:', error);
    throw new Error('申請者データの取得に失敗しました: ' + error.toString());
  }
}
```

### 投票機能 (votes.gs)
```javascript
function addVote(campaignId, applicantId) {
  const sheet = getSheet('votes');
  const values = sheet.getDataRange().getValues();
  
  // 既存の投票記録を探す
  let found = false;
  for (let i = 1; i < values.length; i++) {
    if (values[i][1] === campaignId && values[i][2] === applicantId) {
      // 投票数を+1
      const currentCount = values[i][3] || 0;
      sheet.getRange(i + 1, 4).setValue(currentCount + 1);
      sheet.getRange(i + 1, 5).setValue(getCurrentTimestamp());
      found = true;
      break;
    }
  }
  
  // 新規投票記録を作成
  if (!found) {
    const id = generateId();
    sheet.appendRow([
      id, 
      campaignId, 
      applicantId, 
      1, 
      getCurrentTimestamp()
    ]);
  }
  
  return { success: true };
}

function getVoteCount(campaignId, applicantId) {
  const sheet = getSheet('votes');
  const values = sheet.getDataRange().getValues();
  
  for (let i = 1; i < values.length; i++) {
    if (values[i][1] === campaignId && values[i][2] === applicantId) {
      return values[i][3] || 0;
    }
  }
  
  return 0;
}

function getVotes(campaignId) {
  const sheet = getSheet('votes');
  const data = sheet.getDataRange().getValues();
  
  if (data.length <= 1) return [];
  
  const headers = data[0];
  const rows = data.slice(1);
  
  return rows
    .filter(row => row[1] === campaignId)
    .map(row => arrayToObject(headers, row));
}
```

### フォーム連携機能 (forms.gs)
```javascript
function testFormConnection(sheetUrl) {
  try {
    const match = sheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    if (!match) {
      return {
        success: false,
        error: 'INVALID_URL',
        message: '無効なスプレッドシートURLです'
      };
    }
    
    const sheetId = match[1];
    const ss = SpreadsheetApp.openById(sheetId);
    const sheet = ss.getSheets()[0];
    
    if (!sheet) {
      return {
        success: false,
        error: 'NO_SHEET',
        message: 'シートが見つかりません'
      };
    }
    
    const data = sheet.getDataRange().getValues();
    
    if (data.length === 0) {
      return {
        success: false,
        error: 'NO_DATA',
        message: 'シートにデータがありません'
      };
    }
    
    const headers = data[0];
    const rowCount = data.length - 1;
    
    return {
      success: true,
      data: {
        sheetName: sheet.getName(),
        headers: headers,
        rowCount: rowCount,
        sampleData: data.length > 1 ? data[1] : null
      },
      message: `接続成功！${rowCount}件のデータを検出しました`
    };
    
  } catch (error) {
    console.error('Connection test error:', error);
    
    if (error.toString().includes('Permission denied')) {
      return {
        success: false,
        error: 'PERMISSION_DENIED',
        message: 'アクセス権限がありません',
        guide: {
          title: '権限設定が必要です',
          steps: [
            'スプレッドシートを開いてください',
            '右上の「共有」ボタンをクリック',
            '以下のメールアドレスを追加してください:',
            getScriptEmail(),
            'または「リンクを知っている全員」に閲覧権限を設定'
          ]
        }
      };
    }
    
    return {
      success: false,
      error: 'UNKNOWN_ERROR',
      message: '不明なエラーが発生しました: ' + error.toString()
    };
  }
}

function getFormFields(sheetUrl) {
  try {
    const match = sheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    if (!match) {
      throw new Error('Invalid sheet URL');
    }
    
    const sheetId = match[1];
    const ss = SpreadsheetApp.openById(sheetId);
    const sheet = ss.getSheets()[0];
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    const fields = headers.map((header, index) => {
      const columnData = data.slice(1).map(row => row[index]).filter(val => val !== '');
      
      // データ型を推測
      let type = 'text';
      if (columnData.length > 0) {
        if (columnData.every(val => !isNaN(val) && val !== '')) {
          type = 'number';
        } else if (columnData.every(val => !isNaN(Date.parse(val)))) {
          type = 'date';
        }
      }
      
      return {
        key: header,
        displayName: header,
        type: type,
        visible: true,
        order: index,
        sampleValue: columnData[0] || ''
      };
    });
    
    return {
      success: true,
      fields: fields
    };
    
  } catch (error) {
    return {
      success: false,
      error: error.toString()
    };
  }
}

function getScriptEmail() {
  try {
    return Session.getActiveUser().getEmail();
  } catch (error) {
    return 'apps-script@google.com';
  }
}
```

## ✅ Phase 7: 完成・テスト（1週間）

### デプロイ設定

#### next.config.js
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  env: {
    NEXT_PUBLIC_GAS_API_URL: process.env.NEXT_PUBLIC_GAS_API_URL,
  },
  async headers() {
    return [
      {
        source: '/api/:path*',
        headers: [
          { key: 'Access-Control-Allow-Origin', value: '*' },
          { key: 'Access-Control-Allow-Methods', value: 'GET, POST, PUT, DELETE' },
          { key: 'Access-Control-Allow-Headers', value: 'Content-Type' },
        ],
      },
    ];
  },
};

module.exports = nextConfig;
```

#### 管理ダッシュボード (src/app/admin/page.tsx)
```typescript
'use client';
import Link from 'next/link';
import { useState, useEffect } from 'react';
import { getNotices, getCampaigns } from '@/lib/api';

export default function AdminDashboard() {
  const [stats, setStats] = useState({
    totalNotices: 0,
    activeNotices: 0,
    totalCampaigns: 0,
    activeCampaigns: 0
  });

  useEffect(() => {
    fetchStats();
  }, []);

  const fetchStats = async () => {
    try {
      const [notices, campaigns] = await Promise.all([
        getNotices(),
        getCampaigns()
      ]);
      
      setStats({
        totalNotices: notices.length,
        activeNotices: notices.length, // getNoticesは期間内のもののみ返す
        totalCampaigns: campaigns.length,
        activeCampaigns: campaigns.filter(c => c.status === 'active').length
      });
    } catch (error) {
      console.error('Failed to fetch stats:', error);
    }
  };

  return (
    <div className="max-w-6xl mx-auto p-6">
      <h1 className="text-3xl font-bold mb-8">WEB3 MONEY 管理ダッシュボード</h1>
      
      {/* 統計カード */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div className="bg-white rounded-lg shadow p-6">
          <div className="flex items-center">
            <div className="p-2 bg-blue-100 rounded-lg">
              <svg className="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
              </svg>
            </div>
            <div className="ml-4">
              <p className="text-sm font-medium text-gray-600">表示中お知らせ</p>
              <p className="text-2xl font-semibold text-gray-900">{stats.activeNotices}</p>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow p-6">
          <div className="flex items-center">
            <div className="p-2 bg-green-100 rounded-lg">
              <svg className="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
              </svg>
            </div>
            <div className="ml-4">
              <p className="text-sm font-medium text-gray-600">進行中キャンペーン</p>
              <p className="text-2xl font-semibold text-gray-900">{stats.activeCampaigns}</p>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow p-6">
          <div className="flex items-center">
            <div className="p-2 bg-yellow-100 rounded-lg">
              <svg className="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
              </svg>
            </div>
            <div className="ml-4">
              <p className="text-sm font-medium text-gray-600">総キャンペーン</p>
              <p className="text-2xl font-semibold text-gray-900">{stats.totalCampaigns}</p>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow p-6">
          <div className="flex items-center">
            <div className="p-2 bg-purple-100 rounded-lg">
              <svg className="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </div>
            <div className="ml-4">
              <p className="text-sm font-medium text-gray-600">システム状態</p>
              <p className="text-sm font-semibold text-green-600">正常稼働中</p>
            </div>
          </div>
        </div>
      </div>

      {/* クイックアクション */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-lg font-semibold mb-4">お知らせ管理</h2>
          <p className="text-gray-600 mb-4">新しいお知らせの投稿や既存のお知らせの管理ができます。</p>
          <Link
            href="/admin/notices"
            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors inline-block"
          >
            お知らせ管理
          </Link>
        </div>

        <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-lg font-semibold mb-4">キャンペーン管理</h2>
          <p className="text-gray-600 mb-4">支援金投票キャンペーンの作成・管理ができます。</p>
          <Link
            href="/admin/campaigns"
            className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors inline-block"
          >
            キャンペーン管理
          </Link>
        </div>
      </div>

      {/* 運用ガイド */}
      <div className="bg-white rounded-lg shadow p-6">
        <h2 className="text-lg font-semibold mb-4">運用ガイド</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h3 className="font-medium mb-2">日常的な作業</h3>
            <ul className="text-sm text-gray-600 space-y-1">
              <li>• お知らせ投稿：3分程度</li>
              <li>• キャンペーン開始：10分程度</li>
              <li>• 投票結果確認：随時</li>
            </ul>
          </div>
          <div>
            <h3 className="font-medium mb-2">月次メンテナンス</h3>
            <ul className="text-sm text-gray-600 space-y-1">
              <li>• 終了キャンペーンのアーカイブ</li>
              <li>• 期限切れお知らせの削除</li>
              <li>• システム動作状況の確認</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
}
```

## 🚀 デプロイ手順

### 1. Google Apps Script デプロイ
1. [script.google.com](https://script.google.com) でプロジェクト作成
2. 上記のGASファイルを作成・保存
3. Google Sheetsでデータベース作成
4. 「デプロイ」→「新しいデプロイ」→「ウェブアプリ」
5. アクセス権限：「全員」に設定
6. デプロイURLを取得

### 2. Next.js デプロイ (Vercel)
1. GitHubリポジトリ作成・プッシュ
2. [vercel.com](https://vercel.com) でプロジェクト作成
3. 環境変数設定：`NEXT_PUBLIC_GAS_API_URL`
4. 自動デプロイ完了

### 3. 最終チェックリスト
- [ ] 全ページの動作確認
- [ ] リファラーチェックの動作確認
- [ ] お知らせCRUD機能の確認
- [ ] フォーム連携・投票機能の確認
- [ ] 複数キャンペーン対応の確認
- [ ] キャンペーンのライフサイクル管理
- [ ] 管理画面の操作確認
- [ ] エラーハンドリングの確認
- [ ] レスポンシブ対応の確認
- [ ] アーカイブ機能の確認

---

**この完全実装計画により、要望書の内容を100%実現するWEB3 MONEYシステムが7週間で確実に完成します。**